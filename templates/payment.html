<!-- templates/payment.html -->
{% extends "base.html" %}
{% block title %}Payment - XOXO By SLOG{% endblock %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">Payment Details</h3>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h4>Total Amount: â‚¹{{ total_price }}</h4>
                    </div>
                    
                    <form id="payment-form" method="POST" action="{{ url_for('payment_success') }}">
                        <input type="hidden" name="razorpay_payment_id" id="razorpay_payment_id">
                        <input type="hidden" name="razorpay_order_id" id="razorpay_order_id">
                        <input type="hidden" name="razorpay_signature" id="razorpay_signature">
                        
                        <!-- Delivery Details -->
                        <div class="mb-3">
                            <label for="delivery_address" class="form-label">Delivery Address</label>
                            <input type="text" class="form-control" id="delivery_address" name="delivery_address" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="delivery_city" class="form-label">City</label>
                                <input type="text" class="form-control" id="delivery_city" name="delivery_city" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="delivery_state" class="form-label">State</label>
                                <input type="text" class="form-control" id="delivery_state" name="delivery_state" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="delivery_pincode" class="form-label">Pincode</label>
                                <input type="text" class="form-control" id="delivery_pincode" name="delivery_pincode" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="delivery_phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="delivery_phone" name="delivery_phone" required>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="button" id="pay-button" class="btn btn-primary">Pay Now</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.getElementById('pay-button').onclick = function() {
    // First create the order
    fetch('/create_payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }
        
        var options = {
            key: "{{ config.RAZORPAY_KEY_ID }}",
            amount: data.amount,
            currency: data.currency,
            name: "XOXO By SLOG",
            description: "Payment for Order",
            order_id: data.id,
            handler: function (response) {
                document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
                document.getElementById('razorpay_order_id').value = response.razorpay_order_id;
                document.getElementById('razorpay_signature').value = response.razorpay_signature;
                document.getElementById('payment-form').submit();
            },
            prefill: {
                name: "{{ current_user.name }}",
                email: "{{ current_user.email }}",
                contact: document.getElementById('delivery_phone').value
            },
            theme: {
                color: "#3399cc"
            },
            modal: {
                ondismiss: function() {
                    console.log('Checkout form closed');
                }
            }
        };
        
        var rzp1 = new Razorpay(options);
        rzp1.open();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your payment. Please try again.');
    });
};
</script>
{% endblock %}